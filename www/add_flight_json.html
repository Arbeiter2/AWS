<!DOCTYPE html>
<html lang="en-US">
<head>
<title>AWS - Add flight data</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel='styleSheet' href='style.css' type="text/css" media='screen' />

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>



</head>

<body>

<div class='form'>
<form method="post" id='fenris'>
<table>
<tr>
<td>
	<label for="json_text" id="json_text-label">JSON Text</label>
<textarea id="flight_json_text" style="width: 800px; height: 400px;"></textarea>
	</td>
</tr>

<tr>
<td colspan='2' style='text-align: right;'>
<button id='cmdBtn' class='blueBtn'>Send</button>
</td>
</tr>
</table>


</form>
</div>


<div class='viewer' id='viewer'>

</div> <!-- viewer -->

<script>
function send(e)
{
	e.preventDefault();

	var instance = new Array(6).join().replace(/(.|$)/g, function(){return ((Math.random()*36)|0).toString(36)[Math.random()<0.5?"toString":"toUpperCase"]();});
	
	
	// allows a sequence of objects from different games to be pasted together, so turns them into an array
	var t = '[' + $('#flight_json_text').val().replace(/}\s*{/g, '},{') + ']';
	var data = jQuery.parseJSON(t);
	
	//console.log("data: "+JSON.stringify(data));
	//console.log("data: "+JSON.stringify(data[0]));
	
	// group flights by game_id
	var postData = {};
	var gameIDs = {};
	
	for (i=0; i < data.length; i++)
	{
		var game_id = data[0].game_id;
		
		// add this game_id to the list to be processed
		if (gameIDs[game_id] === undefined)
		{
			gameIDs[game_id] = 1;
			postData["g_" + game_id] = { game_id : game_id, newFlightData : {} };
		}
		
		postData["g_" + game_id].newFlightData["fl_" +  data[i].flight_id] = data[i];
	}

	for (key in postData)
	{
		game_id = key.replace(/\D+/, '');
		
		//console.log(JSON.stringify(postData[key], null, 4));

			
		$.ajax({
			type: 'POST',
			url: '/aws/add_routes.php',
			data: 
			{ 
				game_id : game_id, 
				instance : instance,
				newFlightData : JSON.stringify(postData[key].newFlightData) 
			},
			dataType: 'json'
		}).done(function (response)
		{
			//console.log(response);
			//$('#viewer').append("Added routes for game_id [" + game_id + "]<br>");
			$('#viewer').append("Added [" + response.flight_numbers.join(', ') + "]<br>");
		});	
	}
}

$(document).ready(function ()
{
	$('#cmdBtn').click(send);
});


</script>
</body>
</html>
